name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Trunk version for caching
  TRUNK_VERSION: "0.21.5"

jobs:
  fmt:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: fmt
          cache-on-failure: true

      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy (Backend & MCP)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libgstreamer-plugins-bad1.0-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-tools
          version: 1.1

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: clippy-backend
          cache-on-failure: true

      - name: Run Clippy on backend
        run: cargo clippy --package strom-backend --all-targets --all-features -- -D warnings

      - name: Run Clippy on MCP server
        run: cargo clippy --package strom-mcp-server --all-targets --all-features -- -D warnings

  clippy-frontend:
    name: Clippy (Frontend WASM)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable with WASM target
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
          targets: wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: clippy-frontend
          cache-on-failure: true

      - name: Run Clippy on frontend
        run: cargo clippy --package strom-frontend --target wasm32-unknown-unknown --all-features -- -D warnings

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libgstreamer-plugins-bad1.0-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-tools
          version: 1.1

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: test
          cache-on-failure: true

      - name: Run tests on backend
        run: cargo test --package strom-backend --all-features

      - name: Run tests on MCP server
        run: cargo test --package strom-mcp-server --all-features

  build:
    name: Build (Backend + Frontend + MCP)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable with WASM target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libgstreamer-plugins-bad1.0-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-tools
          version: 1.1

      - name: Cache trunk binary
        id: cache-trunk
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/trunk
          key: trunk-${{ env.TRUNK_VERSION }}-${{ runner.os }}

      - name: Install trunk
        if: steps.cache-trunk.outputs.cache-hit != 'true'
        run: |
          wget -qO- https://github.com/trunk-rs/trunk/releases/download/v${{ env.TRUNK_VERSION }}/trunk-x86_64-unknown-linux-gnu.tar.gz | tar -xzf- -C ~/.cargo/bin

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: build
          cache-on-failure: true
          # Cache trunk build artifacts
          cache-directories: |
            frontend/dist

      - name: Build frontend
        run: |
          cd frontend
          trunk build --release

      - name: Build backend (with embedded frontend)
        run: cargo build --release --package strom-backend

      - name: Build MCP server
        run: cargo build --release --package strom-mcp-server

      - name: Upload backend binary
        uses: actions/upload-artifact@v4
        with:
          name: strom-backend
          path: target/release/strom-backend
          retention-days: 7

      - name: Upload MCP server binary
        uses: actions/upload-artifact@v4
        with:
          name: strom-mcp-server
          path: target/release/strom-mcp-server
          retention-days: 7
