name: Test ARM64 Native Build

on:
  workflow_dispatch:
    inputs:
      glibc_version:
        description: 'Target glibc version (e.g., 2.31 for Ubuntu 20.04)'
        required: false
        type: string
        default: '2.31'

jobs:
  test-arm64-native:
    name: Test native ARM64 build (glibc ${{ inputs.glibc_version }})
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 60
    steps:
      - name: System info
        run: |
          echo "==> Architecture"
          uname -m
          echo "==> OS Release"
          cat /etc/os-release
          echo "==> Host glibc version"
          ldd --version | head -1
          echo "==> Target glibc version: ${{ inputs.glibc_version }}"
          echo "==> CPU info"
          nproc

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Install Zig and cargo-zigbuild
        run: |
          # Install Zig
          ZIG_VERSION="0.13.0"
          curl -L "https://ziglang.org/download/${ZIG_VERSION}/zig-linux-aarch64-${ZIG_VERSION}.tar.xz" | sudo tar -xJ -C /usr/local
          sudo ln -s /usr/local/zig-linux-aarch64-${ZIG_VERSION}/zig /usr/local/bin/zig
          zig version
          # Install cargo-zigbuild
          cargo install --locked cargo-zigbuild

      - name: Install GStreamer dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libunwind-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-bad1.0-dev \
            libssl-dev \
            pkg-config

      - name: Build backend (native ARM64, targeting glibc ${{ inputs.glibc_version }})
        env:
          # Tell Zig linker where to find system libraries (GStreamer, etc.)
          RUSTFLAGS: "-L /usr/lib/aarch64-linux-gnu"
        run: |
          echo "==> Building strom natively on ARM64, targeting glibc ${{ inputs.glibc_version }}"
          cargo zigbuild --release --package strom --features no-gui \
            --target aarch64-unknown-linux-gnu.${{ inputs.glibc_version }}
          echo "==> Build complete!"
          ls -la target/aarch64-unknown-linux-gnu/release/strom
          file target/aarch64-unknown-linux-gnu/release/strom

      - name: Build MCP server
        env:
          RUSTFLAGS: "-L /usr/lib/aarch64-linux-gnu"
        run: |
          cargo zigbuild --release --package strom-mcp-server \
            --target aarch64-unknown-linux-gnu.${{ inputs.glibc_version }}
          ls -la target/aarch64-unknown-linux-gnu/release/strom-mcp-server
          file target/aarch64-unknown-linux-gnu/release/strom-mcp-server

      - name: Verify glibc symbols
        run: |
          echo "==> Checking glibc symbol versions in binary"
          objdump -T target/aarch64-unknown-linux-gnu/release/strom | grep GLIBC | \
            sed 's/.*GLIBC_/GLIBC_/' | cut -d' ' -f1 | sort -u
          echo "==> Highest glibc version required:"
          objdump -T target/aarch64-unknown-linux-gnu/release/strom | grep GLIBC | \
            sed 's/.*GLIBC_//' | cut -d' ' -f1 | sort -V | tail -1

      - name: Upload ARM64 binaries
        uses: actions/upload-artifact@v4
        with:
          name: strom-arm64-glibc${{ inputs.glibc_version }}
          path: |
            target/aarch64-unknown-linux-gnu/release/strom
            target/aarch64-unknown-linux-gnu/release/strom-mcp-server
