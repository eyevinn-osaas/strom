name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  TRUNK_VERSION: "0.21.14"
  CARGO_INCREMENTAL: 0
  CARGO_BUILD_JOBS: 2

jobs:
  build-frontend:
    name: Build Frontend (WASM)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust stable with WASM target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache trunk binary
        id: cache-trunk
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/trunk
          key: trunk-${{ env.TRUNK_VERSION }}-${{ runner.os }}

      - name: Install trunk
        if: steps.cache-trunk.outputs.cache-hit != 'true'
        run: |
          wget -qO- https://github.com/trunk-rs/trunk/releases/download/v${{ env.TRUNK_VERSION }}/trunk-x86_64-unknown-linux-gnu.tar.gz | tar -xzf- -C ~/.cargo/bin

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: frontend-wasm
          cache-on-failure: true

      - name: Build frontend
        run: |
          cd frontend
          trunk build --release

      - name: Upload frontend dist
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: backend/dist
          retention-days: 1

  build:
    name: Build ${{ matrix.platform }}
    needs: build-frontend
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux
            target: x86_64-unknown-linux-gnu
            binary_ext: ""
          - os: ubuntu-24.04
            platform: linux
            target: aarch64-unknown-linux-gnu
            binary_ext: ""
            cross: true
          - os: windows-latest
            platform: windows
            target: x86_64-pc-windows-msvc
            binary_ext: ".exe"
          - os: macos-latest
            platform: macos
            target: aarch64-apple-darwin
            binary_ext: ""
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Install Rust stable with WASM target and build target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown,${{ matrix.target }}

      # Linux: Install Zig for glibc-targeted builds (supports both x86_64 and ARM64)
      - name: Install Zig (Linux)
        if: matrix.platform == 'linux'
        run: |
          ZIG_VERSION="0.13.0"
          ZIG_TARBALL="zig-linux-x86_64-${ZIG_VERSION}.tar.xz"
          curl -L "https://ziglang.org/download/${ZIG_VERSION}/${ZIG_TARBALL}" -o "/tmp/${ZIG_TARBALL}"
          sudo tar -xf "/tmp/${ZIG_TARBALL}" -C /usr/local
          sudo mv /usr/local/zig-linux-x86_64-${ZIG_VERSION} /usr/local/zig
          sudo ln -s /usr/local/zig/zig /usr/local/bin/zig
          rm "/tmp/${ZIG_TARBALL}"
          zig version

      # Linux: Install cargo-zigbuild for glibc-targeted compilation
      - name: Install cargo-zigbuild (Linux)
        if: matrix.platform == 'linux'
        run: cargo install --locked cargo-zigbuild

      # Linux x86_64: Install GStreamer via apt (ubuntu-24.04 has 1.24+)
      - name: Cache apt packages (Linux x86_64)
        if: matrix.platform == 'linux' && matrix.target == 'x86_64-unknown-linux-gnu'
        uses: awalsh128/cache-apt-pkgs-action@v1
        with:
          packages: libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libgstreamer-plugins-bad1.0-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly gstreamer1.0-libav gstreamer1.0-tools
          version: 1.1

      # Linux ARM64: Install cross-compilation tools and ARM64 GStreamer (ubuntu-24.04 has 1.24+)
      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.platform == 'linux' && matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo dpkg --add-architecture arm64
          # Backup and disable original sources
          sudo mv /etc/apt/sources.list /etc/apt/sources.list.disabled
          sudo mv /etc/apt/sources.list.d /etc/apt/sources.list.d.disabled || true
          sudo mkdir -p /etc/apt/sources.list.d
          # Create explicit amd64 sources
          cat <<EOF | sudo tee /etc/apt/sources.list
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu $(lsb_release -sc) main universe
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu $(lsb_release -sc)-updates main universe
          deb [arch=amd64] http://archive.ubuntu.com/ubuntu $(lsb_release -sc)-security main universe
          EOF
          # Create ARM64 sources from Ubuntu ports
          cat <<EOF | sudo tee /etc/apt/sources.list.d/arm64.list
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -sc) main universe
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -sc)-updates main universe
          deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -sc)-security main universe
          EOF
          sudo apt-get update
          sudo apt-get install -y libssl-dev:arm64 pkg-config:arm64 libunwind-dev:arm64
          sudo apt-get install -y libgstreamer1.0-dev:arm64 libgstreamer-plugins-base1.0-dev:arm64 libgstreamer-plugins-bad1.0-dev:arm64
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig" >> $GITHUB_ENV
          echo "AARCH64_UNKNOWN_LINUX_GNU_OPENSSL_LIB_DIR=/usr/lib/aarch64-linux-gnu" >> $GITHUB_ENV

      # Windows: Install GStreamer and pkg-config via Chocolatey
      - name: Install GStreamer (Windows)
        if: matrix.platform == 'windows'
        run: |
          choco install pkgconfiglite gstreamer gstreamer-devel --yes --no-progress
          echo "GSTREAMER_1_0_ROOT_MSVC_X86_64=D:\gstreamer\1.0\msvc_x86_64\" >> $env:GITHUB_ENV
          echo "D:\gstreamer\1.0\msvc_x86_64\bin" >> $env:GITHUB_PATH
          echo "PKG_CONFIG_PATH=D:\gstreamer\1.0\msvc_x86_64\lib\pkgconfig" >> $env:GITHUB_ENV

      # macOS: Install GStreamer via Homebrew
      - name: Install GStreamer (macOS)
        if: matrix.platform == 'macos'
        run: |
          brew install gstreamer gst-plugins-base gst-plugins-good gst-plugins-bad gst-plugins-ugly gst-libav

      # Download the pre-built frontend from the frontend build job
      - name: Download frontend dist
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: backend/dist

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-${{ matrix.platform }}-${{ matrix.os }}
          cache-on-failure: true

      - name: Build backend (with embedded frontend)
        run: |
          if [ "${{ matrix.platform }}" = "linux" ]; then
            # Use cargo-zigbuild for Linux to target glibc 2.31 (Ubuntu 20.04+)
            cargo zigbuild --release --package strom --target ${{ matrix.target }}.2.31
          else
            # Use standard cargo build for non-Linux platforms
            cargo build --release --package strom --target ${{ matrix.target }}
          fi

      - name: Build MCP server
        run: |
          if [ "${{ matrix.platform }}" = "linux" ]; then
            # Use cargo-zigbuild for Linux to target glibc 2.31 (Ubuntu 20.04+)
            cargo zigbuild --release --package strom-mcp-server --target ${{ matrix.target }}.2.31
          else
            # Use standard cargo build for non-Linux platforms
            cargo build --release --package strom-mcp-server --target ${{ matrix.target }}
          fi

      - name: Upload backend binary
        uses: actions/upload-artifact@v4
        with:
          name: strom-v${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/strom${{ matrix.binary_ext }}
          retention-days: 90

      - name: Upload MCP server binary
        uses: actions/upload-artifact@v4
        with:
          name: strom-mcp-server-v${{ steps.version.outputs.version }}-${{ matrix.platform }}-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/strom-mcp-server${{ matrix.binary_ext }}
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Rename binaries with platform suffixes
          mv artifacts/strom-v${{ steps.version.outputs.version }}-linux-x86_64-unknown-linux-gnu/strom \
             release-assets/strom-v${{ steps.version.outputs.version }}-linux-x86_64

          mv artifacts/strom-v${{ steps.version.outputs.version }}-linux-aarch64-unknown-linux-gnu/strom \
             release-assets/strom-v${{ steps.version.outputs.version }}-linux-aarch64

          mv artifacts/strom-v${{ steps.version.outputs.version }}-macos-aarch64-apple-darwin/strom \
             release-assets/strom-v${{ steps.version.outputs.version }}-macos-aarch64

          mv artifacts/strom-v${{ steps.version.outputs.version }}-windows-x86_64-pc-windows-msvc/strom.exe \
             release-assets/strom-v${{ steps.version.outputs.version }}-windows-x86_64.exe

          mv artifacts/strom-mcp-server-v${{ steps.version.outputs.version }}-linux-x86_64-unknown-linux-gnu/strom-mcp-server \
             release-assets/strom-mcp-server-v${{ steps.version.outputs.version }}-linux-x86_64

          mv artifacts/strom-mcp-server-v${{ steps.version.outputs.version }}-linux-aarch64-unknown-linux-gnu/strom-mcp-server \
             release-assets/strom-mcp-server-v${{ steps.version.outputs.version }}-linux-aarch64

          mv artifacts/strom-mcp-server-v${{ steps.version.outputs.version }}-macos-aarch64-apple-darwin/strom-mcp-server \
             release-assets/strom-mcp-server-v${{ steps.version.outputs.version }}-macos-aarch64

          mv artifacts/strom-mcp-server-v${{ steps.version.outputs.version }}-windows-x86_64-pc-windows-msvc/strom-mcp-server.exe \
             release-assets/strom-mcp-server-v${{ steps.version.outputs.version }}-windows-x86_64.exe

          chmod +x release-assets/strom-*-linux-* release-assets/strom-*-macos-* release-assets/strom-mcp-server-*-linux-* release-assets/strom-mcp-server-*-macos-*
          ls -lh release-assets/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: false
          generate_release_notes: true
          files: release-assets/*
          body: |
            # Strom v${{ steps.version.outputs.version }}

            ðŸŽ‰ Release of **Strom** - A GStreamer Flow Engine for visual pipeline management!

            ## Features

            ### Backend (strom)
            - **Axum-based REST API** for pipeline management
            - **GStreamer Integration** - Full pipeline lifecycle management
            - **Element Discovery** - Introspect all available GStreamer elements and their properties
            - **Flow Persistence** - JSON-based storage with auto-save
            - **OpenAPI Documentation** - Interactive Swagger UI
            - **WebSocket Support** - Real-time pipeline updates
            - **Server-Sent Events** - Live flow change notifications
            - **DOT Graph Export** - Debug visualization support
            - **Embedded Web UI** - Frontend served from single binary
            - **Native GUI Option** - Optional egui-based native interface
            - **Docker Support** - Multi-platform container builds

            ### Frontend (strom-frontend)
            - **WebAssembly UI** - Built with egui for the web
            - **Node-based Graph Editor** - Visual pipeline construction
            - **Element Palette** - Searchable catalog with filtering
            - **Property Inspector** - Configure element parameters
            - **Real-time Controls** - Start/stop/delete pipelines
            - **Debug Graph Viewer** - Visualize GStreamer DOT graphs
            - **Live Updates** - SSE-based automatic flow refresh

            ### MCP Server (strom-mcp-server)
            - **Model Context Protocol** support for LLM integration
            - **Claude Code Integration** - AI-assisted pipeline management

            ## Platform Support
            - **Linux** (x86_64, ARM64)
            - **Windows** (x86_64)
            - **macOS** (Apple Silicon / ARM64)

            ## Docker Images
            Available on Docker Hub: `eyevinntechnology/strom:${{ steps.version.outputs.version }}`
            - Multi-platform support (linux/amd64, linux/arm64)
            - Includes all GStreamer plugins
            - Web UI accessible on port 8080

            ## Installation

            ### Pre-built Binaries
            Download the appropriate binary for your platform from the assets below.

            ### Docker
            ```bash
            docker run -p 8080:8080 eyevinntechnology/strom:${{ steps.version.outputs.version }}
            ```

            ### From Source
            ```bash
            cargo install --path backend
            ```

            ## Quick Start
            ```bash
            # Start the server (headless mode)
            ./strom-v${{ steps.version.outputs.version }}-<platform> --headless

            # Open browser
            http://localhost:8080
            ```

            ## Documentation
            - [README](https://github.com/Eyevinn/strom/blob/main/README.md)
            - [Development Guide](https://github.com/Eyevinn/strom/blob/main/docs/DEVELOPMENT.md)
            - [Docker Guide](https://github.com/Eyevinn/strom/blob/main/docs/DOCKER.md)
            - API Documentation: http://localhost:8080/swagger-ui/
